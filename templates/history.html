<!doctype html>
<html lang="en">
<head>
    <title>Lambda | History</title>

    <!-- jQuery from CDN -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- Bootstrap 5 Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>

    <!-- The meta tags used in the webpage -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Link the local css to the webpage -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/stylesheet.css') }}">  
</head>

<body class="d-grid gap-5 bg-secondary">
    <!-- Include the Navigation Bar -->
    {% include 'include/navigation-bar.html' %}

    <!-- Container for Media History and Video Feed -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar for History Files -->
            <div class="col-md-4 p-3 mb-2 bg-dark text-white border-dashboard" id="logs-history">
                <h2 class="text-center mb-2">History</h2>
                <div class="list-group">
                    {% for log_file in log_files %}
                        <a href="#" class="list-group-item list-group-item-action log-file" data-filename="{{ log_file }}">{{ log_file }}</a>
                    {% endfor %}
                </div>
            </div>

            <!-- Main Content for History Content -->
            <div class="col-md-8 p-3 mb-2 bg-dark text-white border-dashboard" id="main-content">
                <h1 class="text-center mb-2">Content</h1>
                <div class="dashboard-image-container text-center">
                    <!-- Loading circle while waiting for the History Content -->
                    <div class="spinner-border loading-circle" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Modal -->
    <div class="modal" id="mediaModal" tabindex="-1" role="dialog" aria-labelledby="mediaModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mediaModalLabel">Log Media</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <video id="logVideo" controls class="d-none">
                        Your browser does not support the video tag.
                    </video>
                    <img id="logImage" class="img-fluid d-none" alt="Log Image">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const logFileLinks = document.querySelectorAll('.log-file');

            logFileLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault();

                    const filename = this.getAttribute('data-filename');
                    fetchLogFileContent(filename);
                });
            });

            function fetchLogFileContent(filename) {
                fetch(`/get_log_content?filename=${filename}`)
                .then(response => response.text())
                .then(data => {
                    // Check if the data is empty
                    if (data.trim() === '') {
                        // Display "No Logs" message
                        document.getElementById('main-content').innerHTML = `<h1 class="text-center mb-2">${filename}</h1> <hr> <p class='log-content'>No History</p>`;
                    } else {
                        // Display the content in the main content area
                        document.getElementById('main-content').innerHTML = `<h1 class="text-center mb-2">${filename}</h1> <hr> <pre class='log-content'>${data}</pre>`;
                        // Register event listeners for the media buttons
                        registerEventListeners();
                    }
                })
                .catch(error => {
                    console.error('Error fetching log file content:', error);
                });
            }

            // Function to register event listeners for view media buttons
            function registerEventListeners() {
                document.querySelectorAll('.view-media-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const mediaFilename = this.getAttribute('data-media-filename');
                        const mediaType = this.getAttribute('data-media-type');
                        const videoElement = document.getElementById('logVideo');
                        const imageElement = document.getElementById('logImage');

                        if (mediaType === 'video') {
                            videoElement.innerHTML = '';
                            const videoSource = document.createElement('source');
                            videoSource.src = `/static/video/${mediaFilename}`;
                            videoSource.type = 'video/mp4';
                            videoElement.appendChild(videoSource);
                            videoElement.classList.remove('d-none');
                            imageElement.classList.add('d-none');
                            videoElement.load();
                            $('#mediaModal').modal('show');
                        } else if (mediaType === 'image') {
                            imageElement.src = `/static/detected_faces/${mediaFilename}`;
                            videoElement.classList.add('d-none');
                            imageElement.classList.remove('d-none');
                            $('#mediaModal').modal('show');
                        } else {
                            alert('No media available for this log entry.');
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>
