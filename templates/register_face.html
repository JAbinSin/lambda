<!doctype html>
<html lang="en">
<head>
    <title>Lambda | Register Face</title>

    <!-- Bootstrap 5 Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>

    <!-- The meta tags used in the webpage -->
    <!-- charset="utf-8" to use almost all the character and symbol in the world -->
    <!-- viewport to make the webpage more responsive -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Link the local css to the webpage -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/stylesheet.css') }}">    
</head>

<body class="d-grid gap-5 bg-secondary">
    <!-- Include the Navigation Bar -->
    {% include 'include/navigation-bar.html' %}

    <!-- Container for Media History and Video Feed -->
    <div class="container-fluid">

        <!-- Main Content for Video Feed -->
        <div class="col-md-8 mx-auto p-3 mb-2 bg-dark text-white border-dashboard">
            <h1 class="text-center mb-4">Register Faces</h1>
            <div class="dashboard-image-container text-center">
				<!-- Loading circle while waiting for the video feed -->
				<div class="spinner-border loading-circle" role="status"></div>
                <img src="{{ url_for('register_feed') }}" id= "videoFeed"class="img-fluid rounded-3" alt="Live Camera" onload="removeLoading()">
            </div>
        </div>
    </div>

	<!-- Modal -->
	<div class="modal fade" id="completionModal" tabindex="-1" aria-labelledby="completionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="completionModalLabel">Registration Complete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" disabled></button>
                </div>
                <div class="modal-body text-center">
                    <p class="text-start">The face registration process is complete.</p>
					<p class="text-start">Training in Progress.</p>
					<div class="spinner-border loading-circle" role="status"></div>
                </div>
                <div class="modal-footer">
                    <!-- Disabled "Return" button initially -->
					<a href="{{ url_for('manage_face') }}" class="btn btn-primary disabled" id="confirmReturnBtn">Return</a>
                </div>
            </div>
        </div>
    </div>

	<script>
        function removeLoading() {
            // Remove the loading circle once the img element loads
            document.querySelector('.loading-circle').style.display = 'none';
        }

		// Function to enable or disable the "Return" button based on the training completion
		function toggleReturnButton(trainingComplete) {
			const returnButton = document.getElementById('confirmReturnBtn');
            const modalBody = document.querySelector('#completionModal .modal-body');
			if (trainingComplete) {
				returnButton.classList.remove('disabled');
                modalBody.innerHTML = `
                    <p class="text-start">The face registration process is complete.</p>
                    <p class="text-start">Training is complete.</p>
                `;
			} else {
				returnButton.classList.add('disabled');
			}
		}

		// Wait for the completion of image capture to show modal
		document.addEventListener('DOMContentLoaded', (event) => {
            const checkCompletion = setInterval(() => {
                fetch('/check_completion')
                    .then(response => response.json())
                    .then(data => {
                        if (data.complete) {
                            clearInterval(checkCompletion);
                            const completionModal = new bootstrap.Modal(document.getElementById('completionModal'));
                            completionModal.show();
                        }
                    })
                    .catch(error => {
                        console.error('Error checking completion:', error);
                    });
            }, 1000);
        });

		// Check for training completion to enable the "Return" button
		document.addEventListener('DOMContentLoaded', (event) => {
			const checkTrainingCompletion = setInterval(() => {
				fetch('/check_training_completion')
					.then(response => response.json())
					.then(data => {
						if (data.complete) {
							toggleReturnButton(true);
							clearInterval(checkTrainingCompletion);
						}
					})
					.catch(error => {
						console.error('Error checking training completion:', error);
					});
			}, 1000);
		});
    </script>
</body>
</html>
